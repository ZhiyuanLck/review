\RequirePackage{expl3, rv-utils}
\ProvidesExplPackage
  {review}
  {2020/09/26}
  {v1.0}
  {review something}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% review class init

\seq_new:N \g__rv_class_seq
\seq_new:N \g__rv_show_class_seq
\seq_new:N \g__rv_show_group_seq
\clist_new:N \g__rv_review_point_clist

\NewDocumentCommand { \rvsetclass } { m }
  {
    \__rv_set_class:n { #1 }
  }

\cs_new_protected:Nn \__rv_set_class:n
  {
    \rv_seq_gappend_clist_remove_duplicates:Nn \g__rv_class_seq { #1 }
    \clist_map_inline:nn { #1 }
      { \__rv_set_single_class:n { ##1 } }
  }

\cs_new_protected:Nn \__rv_set_single_class:n
  {
    \tl_clear_new:N \l__rv_class_tl
    \int_gzero_new:c { g__rv_#1_groupid_int }

    \tl_set:Nn \l__rv_class_tl { #1 }
    \seq_gput_right:Nn \g__rv_class_seq { #1 }

    % prop name sequence
    \seq_gclear_new:c { g__rv_#1_prop_seq }

    % group seq name
    \seq_gclear_new:c { g__rv_#1_global_group_seq }
    \seq_gput_right:cn { g__rv_#1_global_group_seq } { star }
    \seq_gclear_new:c { g__rv_#1_local_group_seq }
    \seq_gput_right:cn { g__rv_#1_local_group_seq } { group }

    \__rv_set_single_class_kv:n { #1 }
  }

\cs_new_protected:Nn \__rv_set_single_class_kv:n
  {
    \keys_define:nn { review / #1 }
      {
        prop .code:n =
          {
            \rv_seq_gappend_clist_remove_duplicates:cn
              { g__rv_#1_prop_seq } { ##1 }
          },
        local-group .code:n =
          {
            \rv_seq_gappend_clist_remove_duplicates:cn
              { g__rv_#1_local_group_seq } { ##1 }
          },
        global-group .code:n =
          {
            \rv_seq_gappend_clist_remove_duplicates:cn
              { g__rv_#1_global_group_seq } { ##1 }
          },
        show .code:n =
          {
            \seq_gset_from_clist:cn { g__rv_#1_show_group_seq } { ##1 }
          }
      }
  }

\keys_define:nn { review }
  {
    review-point .clist_gset:N = \g__rv_review_point_clist,
    show .code:n = { \seq_gset_from_clist:Nn \g__rv_show_class_seq { #1 } },
  }

\keys_set:nn { review }
  {
    review-point = { 2, 4, 7, 15, 30, 60 },
  }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% option setting command

\NewDocumentCommand { \rvsetup } { m }
  {
    \__rv_check_class_not_set:
    \keys_set:nn { review } { #1 }
  }

% #1 class list #2 common keys set
\NewDocumentCommand { \rvsetupsub } { m m }
  {
    \__rv_check_class_not_set:
    \clist_map_inline:nn { #1 }
      { \__rv_setup_sub:nn { ##1 } { #2 } }
  }

\NewDocumentCommand { \rvsetupall } { m }
  {
    \__rv_check_class_not_set:
    \seq_map_inline:Nn \g__rv_class_seq
      { \__rv_setup_sub:nn { ##1 } { #1 } }
  }

% #1 class #2 key-val
\cs_new_protected:Nn \__rv_setup_sub:nn
  {
    \__rv_check_class_not_define:nn { #1 } { critical }
    \keys_set:nn { review / #1 } { #2 }
  }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Env set

% #1 class #2 ggroup name #3 prop #4 content
\cs_new_protected:Nn \__rv_save_global_group_prop:nnnn
  {
    \__rv_check_group_not_define:nnn { #1 } { #2 } { global }
    \__rv_check_prop_not_define:nn { #1 } { #3 }
    \seq_gput_right:cn { g__rv_#1_global_group_#2_prop_#3_seq } { #4 }
  }

% #1 class #2 ggroup name #3 prop #4 content
\cs_new_protected:Nn \__rv_save_local_group_prop:nnnn
  {
    \__rv_check_group_not_define:nnn { #1 } { #2 } { local }
    \__rv_check_prop_not_define:nn { #1 } { #3 }
    \seq_gput_right:cn
      {
        g__rv_#1_local_group_#2_prop_#3_
        \int_use:c { g__rv_#1_groupid_int }
        _seq
      } { #4 }
  }

\clist_map_inline:nn { New, Renew, Declare, Provide }
  {
    \cs_new_protected:cpn { #1rvGroupEnvironment } ##1##2##3##4
      {
        \__rv_new_group_env:nnnnn { #1 } { ##1 } { ##2 } { ##3} { ##4 }
      }
  }

% #1 new/declare/renew/provide #2 classes
\cs_new_protected:Nn \__rv_new_group_env:nnnnn
  {
    \__rv_check_class_not_set:
    \tl_set:Nn \l__rv_env_tmpa_tl { #4 }
    \tl_set:Nn \l__rv_env_tmpb_tl { #5 }
    \clist_map_inline:nn { #2 }
      {
        \__rv_new_single_group_env:nnnVV { #1 } { ##1 } { #3 }
        \l__rv_env_tmpa_tl
        \l__rv_env_tmpb_tl
      }
  }

\cs_new_protected:Nn \__rv_new_single_group_env:nnnnn
  {
    \str_if_in:nnTF { #2 } { = }
      { \rv_utils_get_kv:nNN { #2 } }
      { \rv_utils_get_kv:nNN { #2=rv#2 } }
    \l_tmpa_tl \l_tmpb_tl
    \exp_args:NV \__rv_env_init_global_group:n \l_tmpa_tl
    \exp_args:NV \__rv_check_class_not_define:nn \l_tmpa_tl { critical }
    \__rv_set_single_group_env:nVVnnn { #1 } \l_tmpa_tl \l_tmpb_tl
      { #3 } { #4 } { #5 }
  }
\cs_generate_variant:Nn \__rv_new_single_group_env:nnnnn { nnnVV }

\cs_new_protected:Nn \__rv_set_single_group_env:nnnnnn
  {
    \cs_if_exist_use:c { #1DocumentEnvironment } { #3 } { #4 }
      {
        \__rv_env_init:n { #2 }
        #5
      } { #6 }
  }
\cs_generate_variant:Nn \__rv_set_single_group_env:nnnnnn { nVVnnn }

\cs_new_protected:Nn \__rv_env_init_global_group:n
  {
    \seq_map_inline:cn { g__rv_#1_prop_seq }
      {
        \seq_map_inline:cn { g__rv_#1_global_group_seq }
          {
            \seq_gclear_new:c { g__rv_#1_global_group_####1_prop_##1_seq }
          }
      }
  }

\cs_new_protected:Nn \__rv_env_init:n
  {
    \tl_clear_new:N \l__rv_class_tl
    \tl_set:Nn \l__rv_class_tl { #1 }
    \int_gincr:c { g__rv_#1_groupid_int }

    \__rv_env_init_local_group:n { #1 }
    \__rv_env_init_cs:n { #1 }
  }
\cs_generate_variant:Nn \__rv_env_init:n { V }

\cs_new_protected:Nn \__rv_env_init_local_group:n
  {
    \seq_map_inline:cn { g__rv_#1_prop_seq }
      {
        \seq_map_inline:cn { g__rv_#1_local_group_seq }
          {
            \seq_gclear_new:c
              {
                g__rv_#1_local_group_####1_prop_##1_
                \int_use:c { g__rv_#1_groupid_int }
                _seq
              }
          }
      }
  }

\cs_new_protected:Nn \__rv_env_init_cs:n
  {
    \DeclareDocumentCommand { \rvgroup } { s o m +m }
      {
        \IfBooleanTF { ##1 }
          {
            \IfValueTF { ##2 }
              {
                \__rv_save_global_group_prop:nnnn
                  { #1 } { ##2 } { ##3 } { ##4 }
              }
              {
                \__rv_save_global_group_prop:nnnn
                  { #1 } { star } { ##3 } { ##4 }
              }
          }
          {
            \IfValueTF { ##2 }
              {
                \__rv_save_local_group_prop:nnnn
                  { #1 } { ##2 } { ##3 } { ##4 }
              }
              {
                \__rv_save_local_group_prop:nnnn
                  { #1 } { group } { ##3 } { ##4 }
              }
          }
      }
  }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% show

\cs_new_protected:Nn \__rv_show:
  {
    \__rv_check_class_not_set:
    \seq_map_inline:Nn \g__rv_show_class_seq
      { \__rv_show_class:n { ##1 } }
  }

\cs_new_protected:Nn \__rv_show_class:n
  {
  }


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% package msg

\cs_new_protected:Nn \__rv_msg_new:nn
  {
    \msg_new:nnn { review } { #1 } { #2 }
  }

\cs_new_protected:Nn \__rv_msg_warning:nn
  {
    \msg_warning:nnn { review } { #1 } { #2 }
  }

\cs_new_protected:Nn \__rv_msg_error:n
  {
    \msg_error:nn { review } { #1 }
  }

\cs_new_protected:Nn \__rv_msg_error:nn
  {
    \msg_error:nnn { review } { #1 } { #2 }
  }

\cs_new_protected:Nn \__rv_msg_error:nnn
  {
    \msg_error:nnnn { review } { #1 } { #2 } { #3 }
  }

\cs_new_protected:Nn \__rv_msg_error:nnnn
  {
    \msg_error:nnnnn { review } { #1 } { #2 } { #3 } { #4 }
  }

\cs_new_protected:Nn \__rv_msg_critical:n
  {
    \msg_critical:nn { review } { #1 }
  }

\cs_new_protected:Nn \__rv_msg_critical:nn
  {
    \msg_critical:nnn { review } { #1 } { #2 }
  }

\__rv_msg_new:nn { class-not-set }
  {
    Review~ classes~ is~ not~ set~ or~ empty.~ Please~ set~ classes~ by~
    command~ \rvsetclass~ first.
  }

\__rv_msg_new:nn { class-not-define }
  {
    Review~ class~ '#1'~ not~ defined!
  }

\__rv_msg_new:nn { multi-class-options }
  {
    Please~ do~ not~ set~ review~ classes~ multiple~ times!~ Check~ if~
    there~ are~ duplicated~ '\c_backslash_str rvsetclass'~ commands.
  }

\__rv_msg_new:nn { duplicated-prop }
  {
    Property~ '#2'~ of~ review~ class~ '#1'~ has~ been~ defined.
  }

\__rv_msg_new:nn { prop-not-define }
  {
    Property~ '#2'~ of~ review~ class~ '#1'~ is~ not~ defined.
  }

\__rv_msg_new:nn { group-not-define }
  {
    #3~ group~ '#2'~ of~ review~ class~ '#1'~ is~ not~ defined.
  }

\cs_new_protected:Nn \__rv_check_class_not_set:
  {
    \bool_if:nT
      {
        ! \seq_if_exist_p:N \g__rv_class_seq ||
        \seq_if_empty_p:N \g__rv_class_seq
      }
      { \__rv_msg_critical:n { class-not-set } }
  }

% #1 class #2 msg type
\cs_new_protected:Nn \__rv_check_class_not_define:nn
  {
    \seq_if_in:NnF \g__rv_class_seq { #1 }
      {
        \cs_if_exist_use:c { __rv_msg_#2:nn }
          { class-not-define }
          { #1 }
      }
  }

% #1 class #2 prop
\cs_new_protected:Nn \__rv_check_prop_not_define:nn
  {
    \seq_if_in:cnF { g__rv_#1_prop_seq } { #2 }
      {
        \__rv_msg_error:nnn { prop-not-define } { #1 } { #2 }
      }
  }

% #1 class #2 group #3 group type
\cs_new_protected:Nn \__rv_check_group_not_define:nnn
  {
    \seq_if_in:cnF { g__rv_#1_#3_group_seq } { #2 }
      {
        \__rv_msg_error:nnnn { group-not-define } { #1 } { #2 } { #3 }
      }
  }
\file_input_stop:
